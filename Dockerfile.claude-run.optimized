# syntax=docker/dockerfile:1-labs

# ä½¿ç”¨æ›´æ–°çš„åŸºç¡€é•œåƒï¼Œå¸¦æœ‰æ›´å¥½çš„ç¼“å­˜
FROM node:20-alpine3.22 AS node_base
# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# === Node.js ä¾èµ–é˜¶æ®µ ===
FROM node_base AS node_deps
# åªå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨ Docker å±‚ç¼“å­˜
COPY package.json package-lock.json ./
# ä½¿ç”¨ npm ci å¹¶è¡Œå®‰è£…ï¼Œå¯ç”¨ç¼“å­˜
RUN npm ci --legacy-peer-deps --prefer-offline --no-audit --cache /tmp/.npm

# === Node.js æ„å»ºé˜¶æ®µ ===
FROM node_base AS node_builder
# å¤åˆ¶ä¾èµ–
COPY --from=node_deps /app/node_modules ./node_modules
# åªå¤åˆ¶æ„å»ºéœ€è¦çš„æ–‡ä»¶
COPY package.json package-lock.json next.config.ts tsconfig.json tailwind.config.js postcss.config.mjs ./
COPY src/ ./src/
COPY public/ ./public/

# ä¼˜åŒ–æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_OPTIONS="--max-old-space-size=6144"
ENV NEXT_TELEMETRY_DISABLED=1
ENV CI=true
ENV NODE_ENV=production

# å¹¶è¡Œæ„å»º
RUN npm run build

# === Python ä¾èµ–é˜¶æ®µï¼ˆå¹¶è¡Œä¼˜åŒ–ï¼‰===
FROM python:3.11-slim AS py_deps
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰éœ€è¦çš„åŒ…ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# åªå¤åˆ¶ requirements.txtï¼Œåˆ©ç”¨ç¼“å­˜
COPY api/requirements.txt ./api/
# ä½¿ç”¨å¹¶è¡Œå®‰è£…å’Œç¼“å­˜ä¼˜åŒ–
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r api/requirements.txt

# é¢„ä¸‹è½½ tiktoken ç¼–ç ï¼ˆé¿å…è¿è¡Œæ—¶ç½‘ç»œè¯·æ±‚ï¼‰
RUN python -c "import tiktoken; tiktoken.get_encoding('cl100k_base')"

# === æœ€ç»ˆè¿è¡Œæ—¶é•œåƒ ===
FROM python:3.11-slim

WORKDIR /app

# ä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    gnupg \
    git \
    ca-certificates \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½® Python ç¯å¢ƒ
ENV PATH="/opt/venv/bin:$PATH"

# å¤åˆ¶ Python ä¾èµ–ï¼ˆä»ç¼“å­˜å±‚ï¼‰
COPY --from=py_deps /opt/venv /opt/venv

# å¤åˆ¶ API ä»£ç 
COPY api/ ./api/

# å¤åˆ¶ Node.js åº”ç”¨ï¼ˆä»ç¼“å­˜å±‚ï¼‰
COPY --from=node_builder /app/public ./public
COPY --from=node_builder /app/.next/standalone ./
COPY --from=node_builder /app/.next/static ./.next/static
COPY package.json ./

# åˆ›å»ºç›®å½•
RUN mkdir -p /app/api/logs

# æš´éœ²ç«¯å£
EXPOSE 8001 3000

# åˆ›å»ºä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
FRONTEND_PORT=${PORT:-3000}\n\
API_PORT=8001\n\
\n\
echo "ğŸš€ Starting DeepWiki services..."\n\
echo "ğŸ“¡ API Port: $API_PORT"\n\
echo "ğŸŒ Frontend Port: $FRONTEND_PORT"\n\
\n\
# å¯åŠ¨ APIï¼ˆåå°ï¼‰\n\
echo "ğŸš€ Starting API server..."\n\
cd /app && API_PORT=$API_PORT python -m api.main > /tmp/api.log 2>&1 &\n\
API_PID=$!\n\
echo "âœ… API started (PID: $API_PID)"\n\
\n\
# ç­‰å¾… API å¯åŠ¨ï¼ˆæ›´é•¿æ—¶é—´ï¼Œæ›´è¯¦ç»†çš„æ—¥å¿—ï¼‰\n\
echo "â³ Waiting for API to be ready..."\n\
for i in {1..60}; do\n\
  if curl -sf http://localhost:$API_PORT/health > /dev/null 2>&1; then\n\
    echo "âœ… API health check passed (attempt $i)"\n\
    break\n\
  fi\n\
  if [ $i -eq 60 ]; then\n\
    echo "âŒ API failed to start after 60 attempts"\n\
    echo "ğŸ” Checking API process..."\n\
    ps aux | grep python || true\n\
    echo "ğŸ” Checking API logs..."\n\
    tail -20 /app/api/logs/application.log 2>/dev/null || echo "No API logs found"\n\
    exit 1\n\
  fi\n\
  echo "â³ API not ready yet (attempt $i/60)"\n\
  sleep 2\n\
done\n\
\n\
# å¯åŠ¨å‰ç«¯\n\
echo "ğŸŒ Starting frontend on port $FRONTEND_PORT..."\n\
cd /app && PORT=$FRONTEND_PORT HOSTNAME=0.0.0.0 node server.js > /tmp/frontend.log 2>&1 &\n\
FRONTEND_PID=$!\n\
echo "âœ… Frontend started (PID: $FRONTEND_PID)"\n\
\n\
# ç­‰å¾…å‰ç«¯å¯åŠ¨\n\
echo "â³ Waiting for frontend to be ready..."\n\
for i in {1..30}; do\n\
  if curl -sf http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then\n\
    echo "âœ… Frontend health check passed (attempt $i)"\n\
    break\n\
  fi\n\
  if [ $i -eq 30 ]; then\n\
    echo "âŒ Frontend failed to start after 30 attempts"\n\
    echo "ğŸ” Frontend logs:"\n\
    tail -20 /tmp/frontend.log 2>/dev/null || echo "No frontend logs found"\n\
    echo "ğŸ” API logs:"\n\
    tail -20 /tmp/api.log 2>/dev/null || echo "No API logs found"\n\
    exit 1\n\
  fi\n\
  echo "â³ Frontend not ready yet (attempt $i/30)"\n\
  sleep 2\n\
done\n\
\n\
# æ¸…ç†å‡½æ•°\n\
cleanup() {\n\
  echo "ğŸ›‘ Shutting down services..."\n\
  kill $API_PID $FRONTEND_PID 2>/dev/null || true\n\
  exit 0\n\
}\n\
\n\
trap cleanup SIGTERM SIGINT\n\
\n\
# ç­‰å¾…ä»»ä¸€è¿›ç¨‹é€€å‡º\n\
wait -n $API_PID $FRONTEND_PID\n\
echo "âš ï¸ One service exited, shutting down..."\n\
cleanup\n\
' > /app/start.sh && chmod +x /app/start.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV SERVER_BASE_URL=http://localhost:8001

# ä¼˜åŒ–çš„å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=45s --retries=3 \
  CMD curl -sf http://localhost:8001/health && curl -sf http://localhost:${PORT:-3000} || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"] 